版权声明：本文为CSDN博主「桃李醉春风SVIP」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。
原文链接：https://blog.csdn.net/qq_42891281/article/details/107387200

### 1、XA/2PC

#### 1.1流程

有一个协调者的角色，分为准备阶段和提交阶段，协调者会同步等待第一阶段的所有服务都准备完成，返回ok。

优点

强一致性

缺点：

第二阶段执行回滚事务提交失败，一直重试，第一阶段执行成功的在回滚前都会阻塞

第二阶段执行事务提交失败，一直重试，知道所有服务都执行成功，否则都会阻塞

协调者单点故障、会对资源造成阻塞、提交事务前/回滚指令发出前协调者挂了，这些第一阶段准备的事务都是阻塞



### 2、3PC

有一个协调者的角色，分为准备阶段、预提交阶段、提交阶段

预提交：数据库执行事务操作，添加redo和undo日志、但不提交，返回ack，等待最后的提交指令，当协调者超时未发送yes信息，会默认提交。保证了不会阻塞。

优点：相对于2PC，3PC主要解决的单点故障问题，并减少阻塞，因为一旦参与者无法及时收到来自协调者的信息之后，他会默认执行commit。而不会一直持有事务资源并处于阻塞状态。

缺点：会导致数据一致性问题。由于网络原因，协调者发送的中断响应没有及时被参与者接收到，那么参与者在等待超时之后执行了commit操作。这样就和其他接到中断命令并执行回滚的参与者之间存在数据不一致的情况。



### 3、TCC

针对每一个事务的操作，进行确认和补偿

优点：流程简单

缺点：代码量多，每一个不同的业务都需要进行补偿的代码编写、幂等性无法保证



### 4、本地消息表（mysql）

提供一个消息表，A服务调用B服务之前就存入对应信息唯一id和状态，B服务执行完成以后成功update之前存入的消息状态

定时扫描消息表，把没有执行完成的消息或者执行失败的消息再重新发送，或者人工介入。

### 5、MQ事务（rocketMQ/rabbitMQ）

RabbitMQ 和 Kafka 都不支持（RabbitMQ、Kafka基于ACK机制）

![img](/Users/admin/Desktop/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQyODkxMjgx,size_16,color_FFFFFF,t_70.png)



![img](https://img-blog.csdnimg.cn/20200716165648572.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQyODkxMjgx,size_16,color_FFFFFF,t_70)

发送一个事务消息，这个时候，RocketMQ将消息状态标记为Prepared，注意此时这条消息消费者是无法消费到的。
执行业务代码逻辑。
确认发送消息，RocketMQ将消息状态标记为可消费，这个时候消费者才能真正消费到这条消息。
如果步骤3确认消息发送失败，RocketMQ会定期扫描消息集群中的事务消息，如果发现了Prepared消息，它会向消息发送端(生产者)确认。RocketMQ会根据发送端设置的策略来决定是回滚还是继续发送确认消息。这样就保证了消息发送与本地事务同时成功或同时失败。
**优点：** 实现了最终一致性，不需要依赖本地数据库事务。

**缺点：** 目前主流MQ中只有RocketMQ支持事务消息（回查事务状态，其他的都没回查事务状态的功能，只能等待ack回调判断B服务是否成功，如果执行失败的情况下，是无法感知是否会滚的）。



### 6、redis（https://blog.csdn.net/weixin_43520450/article/details/107548277）

Redis中，单条命令是原子性执行的，但`事务不保证原子性，且没有回滚，除非指令性错误才全部执行失败`。事务中任意命令执行失败，其余的命令仍会被执行。

multi（原子性） exec discard watch（隔离型、一致性） unwatch

redis的持久化方式决定 数据的持久型

### 7、seata（alibaba）

seata中有两种常见分布式事务实现方。

案，AT及TCC

- 
- AT模式：赖于RM拥有本地数据库事务的能力，对于客户业务无侵入性

**

**。

**。

**。0对业务无侵入**：即减少技术架构上的微服务化所带来的分布式事务问题对业务的侵入 **高性能**：减少分布式事务解决方案所带来的性能消耗(2PC)

- **第一。。。阶段：本地数据备份阶段**
- **第二阶段：全局事务提交/回滚**



。



。。